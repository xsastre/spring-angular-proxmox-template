name: Build, Test i Deploy

# Executa el workflow quan es fa push a main o develop
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  # Job per compilar i testar el projecte
  build-and-test:
    name: Build i Test
    runs-on: ubuntu-latest
    
    steps:
      # Checkout del codi
      - name: Checkout del repositori
        uses: actions/checkout@v4

      # Configurar Java 17
      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # Compilar i testar el backend
      - name: Compilar i testar Backend
        working-directory: ./backend
        run: |
          chmod +x mvnw
          ./mvnw clean test
          ./mvnw package -DskipTests

      # Configurar Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      # Instal·lar dependències del frontend
      - name: Instal·lar dependències Frontend
        working-directory: ./frontend
        run: npm ci

      # Compilar el frontend
      - name: Compilar Frontend
        working-directory: ./frontend
        run: npm run build:prod

      # Guardar els artefactes per al deploy
      - name: Guardar JAR del backend
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar
          retention-days: 1

      - name: Guardar build del frontend
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 1

  # Job per desplegar a Proxmox LXC (només a la branca main)
  deploy:
    name: Deploy a Proxmox LXC
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      # Descarregar els artefactes
      - name: Descarregar JAR del backend
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./backend-jar

      - name: Descarregar build del frontend
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: ./frontend-build

      # Configurar clau SSH
      - name: Configurar clau SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.LXC_IP }} >> ~/.ssh/known_hosts

      # Desplegar el backend
      - name: Copiar JAR al contenidor LXC
        run: |
          scp -i ~/.ssh/id_rsa ./backend-jar/*.jar ${{ secrets.SSH_USER }}@${{ secrets.LXC_IP }}:/opt/app/backend.jar

      # Desplegar el frontend
      - name: Copiar build del frontend al contenidor LXC
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.LXC_IP }} "rm -rf /var/www/html/*"
          scp -i ~/.ssh/id_rsa -r ./frontend-build/template-daw-frontend/* ${{ secrets.SSH_USER }}@${{ secrets.LXC_IP }}:/var/www/html/

      # Reiniciar els serveis
      - name: Reiniciar serveis al contenidor LXC
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.LXC_IP }} << 'EOF'
            # Reiniciar el servei del backend (ajustar segons la configuració)
            sudo systemctl restart backend.service || echo "Servei backend no configurat"
            
            # Reiniciar Nginx
            sudo systemctl restart nginx
          EOF

      # Verificar el desplegament
      - name: Verificar estat dels serveis
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.LXC_IP }} << 'EOF'
            echo "=== Estat del servei backend ==="
            sudo systemctl status backend.service --no-pager || echo "Servei backend no configurat"
            
            echo "=== Estat de Nginx ==="
            sudo systemctl status nginx --no-pager
          EOF
